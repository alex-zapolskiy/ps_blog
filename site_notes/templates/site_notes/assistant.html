{% extends "base.html" %}
{% block content%}
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="main-layout">
        <!-- Блок истории слева -->
        <div class="history-sidebar">
            <div class="history-container">
                <h3>История запросов</h3>
                {% if history %}
                    {% for item in history %}
                        <a href="?history_record={{ item.public_id }}"">{{ item.query|truncatechars:25 }}</a>
                        <p>Модель: {{ item.model_after_slash }}</p>
                        <p>{{ item.time_create }}</p>
                    {% endfor %}
                {% elif user.is_authenticated %}
                    <p>История пока пуста</p>
                {% else %}
                    <p> Войдите, чтобы увидить историю запросов</p>
                {% endif %}
            </div>
        </div>
        <div class="main-content">
            <div class="form-container-assistant">
                <form id="chatForm" method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn btn-primary">Отправить</button>
                    <button type="button" id="stopButton" class="btn btn-danger" style="display: none;">Остановить</button>
                </form>
            </div>

            <div id="response" class="form-container-assistant" style="margin-top: 20px; min-height: 100px;">
                <!-- Ответ будет здесь -->
            </div>
        </div>
    </div>
    <!-- Отображение истории -->
    {% if loaded_response %}
    <script>
        document.getElementById('response').innerHTML = '{{ loaded_response }}'
    </script>
    {% endif %}
<script>
    $(document).ready(function() {
        var xhr = null;
        
        $('#chatForm').on('submit', function(e) {
            e.preventDefault();
            
            var formData = $(this).serialize();
            var responseDiv = $('#response');
            responseDiv.html('');
            
            // Показываем кнопку остановки
            $('#stopButton').show();
            
            // Используем простой XMLHttpRequest
            xhr = new XMLHttpRequest();
            var receivedLength = 0;
            
            xhr.open('POST', window.location.href);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onprogress = function(e) {
                if (xhr.readyState === 3 && xhr.status === 200) {
                    var currentText = xhr.responseText;
                    if (currentText.length > receivedLength) {
                        var newText = currentText.substring(receivedLength);
                        receivedLength = currentText.length;
                        responseDiv.append(newText);
                        responseDiv.scrollTop(responseDiv[0].scrollHeight);
                    }
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log('Запрос завершен');
                    // Скрываем кнопку остановки после завершения
                    $('#stopButton').hide();
                }
            };
            
            xhr.onerror = function() {
                responseDiv.html('Ошибка при отправке запроса');
                // Скрываем кнопку остановки при ошибке
                $('#stopButton').hide();
            };
            
            xhr.send(formData);
        });
        
        // Обработчик для кнопки остановки
        $('#stopButton').on('click', function() {
            if (xhr && xhr.readyState !== 4) {
                xhr.abort();
                $('#response').append('<p><em>Запрос остановлен пользователем</em></p>');
                $('#stopButton').hide();
                console.log('Запрос остановлен');
            }
        });
    });
</script>
</body>
{% endblock%}